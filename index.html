
<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RED BRAVE BLACK JOMOK by XIONG</title>
  <meta name="description" content="Simple client-side duotone: convert gambar jadi merah & hitam (merah untuk highlights, hitam untuk shadows)." />
  <style>
    :root{
      --bg-1:#070607;   /* very dark */
      --bg-2:#0f0b0b;   /* panel dark */
      --panel:#110808;
      --muted:#d1a0a0;
      --accent:#ef4444; /* red */
      --card-border:rgba(255,255,255,0.03);
    }

    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;background:linear-gradient(180deg,var(--bg-1) 0%, #0b0b0b 100%);color:#fff}

    /* center everything vertically + horizontally */
    .stage{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}

    .wrap{width:100%;max-width:1100px;margin:0 auto;display:flex;flex-direction:column;gap:18px;align-items:center}

    header{display:flex;gap:12px;align-items:center;flex-direction:column;text-align:center}
    header h1{font-size:20px;margin:0;color:var(--accent)}
    header .muted{color:var(--muted);font-size:13px}

    .controls{display:grid;grid-template-columns:1fr 380px;gap:14px;width:100%;align-items:start}

    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:10px;border:1px solid var(--card-border);box-shadow:0 6px 18px rgba(0,0,0,0.6)}

    #drop{min-height:160px;display:flex;align-items:center;justify-content:center;border:2px dashed rgba(255,255,255,0.06);border-radius:8px;padding:12px;text-align:center;cursor:pointer;position:relative;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.15))}
    #drop.small{min-height:110px}

    input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer}

    .controls .card .row{display:flex;gap:10px;align-items:center}
    .sliders{display:flex;gap:12px;align-items:center}
    label{font-size:13px;color:var(--muted)}
    .btn{background:var(--accent);color:#fff;padding:9px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}
    .btn.secondary{background:#2b0b0b}

    #canvas{max-width:100%;display:block;margin-top:6px;border-radius:8px;background:#000;box-shadow:0 8px 30px rgba(0,0,0,0.7)}
    .muted{color:var(--muted);font-size:13px}

    footer{margin-top:6px;color:var(--muted);font-size:13px;text-align:center}

    /* small screens: single column */
    @media (max-width:920px){
      .controls{grid-template-columns:1fr}
      .controls .card{width:100%}
    }
  </style>
</head>
<body>
  <div class="stage">
    <div class="wrap">
      <header>
        <h1>RED BRAVE BLACK JOMOK BY X10N9</h1>
        <div class="muted">(Pemrosesan di browser. Tidak adaji diupload)</div>
      </header>

      <div class="controls">
        <div class="card">
          <div id="drop">Klik atau seret gambar ke sini<br><small class="muted">(jpg, png, webp â€” paste image juga bisa)</small>
            <input id="file" type="file" accept="image/*" aria-label="Pilih gambar" />
          </div>

          <div style="display:flex;gap:10px;justify-content:center;margin-top:12px;flex-wrap:wrap">
            <button id="openBtn" class="btn ghost" title="Buka file">Buka</button>
            <button id="download" class="btn">Simpan PNG</button>
            <button id="reset" class="btn secondary">Reset</button>
          </div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
            <div style="flex:1;min-width:120px">
              <label class="muted">Warna highlight</label><br>
              <input id="color" type="color" value="#ff0000" />
            </div>

            <div style="flex:1;min-width:140px;text-align:right">
              <label class="muted">Gamma / Kontras</label><br>
              <input id="gamma" type="range" min="0.3" max="2.5" step="0.05" value="1" style="width:140px;" />
              <div class="muted" id="gammaVal">1.00</div>
            </div>
          </div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;gap:12px;flex-wrap:wrap">
            <div style="flex:1;min-width:120px">
              <label class="muted">Intensitas</label><br>
              <input id="intensity" type="range" min="0" max="1" step="0.01" value="1" style="width:100%" />
              <div class="muted" id="intVal">1.00</div>
            </div>

            <div style="flex:1;min-width:140px;text-align:right">
              <label class="muted">Mix dengan grayscale</label><br>
              <input id="mix" type="range" min="0" max="1" step="0.01" value="0" style="width:140px;" />
              <div class="muted" id="mixVal">0.00</div>
            </div>
          </div>
        </div>
      </div>

      <div style="width:100%;display:flex;justify-content:center;align-items:center;flex-direction:column">
        <canvas id="canvas" role="img" aria-label="Preview gambar duotone"></canvas>
        <div style="margin-top:8px;color:var(--muted);font-size:13px;text-align:center;max-width:860px">
          <div id="info" class="muted">Belum ada gambar. Klik "Buka" atau seret gambar ke area.</div>
        </div>
      </div>

      <footer>
        <div class="muted">Catatan: Orientation EXIF sederhana tidak ditangani. Untuk file besar, proses dibatasi agar tidak membebani browser.</div>
      </footer>
    </div>
  </div>

  <script>
    // ============ CONFIG ============
    const MAX_DIMENSION = 2000; // batasi ukuran pixel
    // =================================

    const fileEl = document.getElementById('file');
    const drop = document.getElementById('drop');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });

    const colorEl = document.getElementById('color');
    const gammaEl = document.getElementById('gamma');
    const intensityEl = document.getElementById('intensity');
    const mixEl = document.getElementById('mix');
    const downloadBtn = document.getElementById('download');
    const resetBtn = document.getElementById('reset');
    const openBtn = document.getElementById('openBtn');

    const gammaVal = document.getElementById('gammaVal');
    const intVal = document.getElementById('intVal');
    const mixVal = document.getElementById('mixVal');
    const info = document.getElementById('info');

    let currentImage = null; // {w,h}
    let originalImageData = null; // ImageData backup
    let originalBlob = null; // keep original blob for reloading if needed

    function hexToRgb(hex){
      const n = hex.replace('#','');
      return [parseInt(n.substring(0,2),16), parseInt(n.substring(2,4),16), parseInt(n.substring(4,6),16)];
    }

    function clamp(v,min,max){return Math.max(min,Math.min(max,v));}

    function drawImageToCanvas(img){
      // resize to fit MAX_DIMENSION while keeping ratio
      let w = img.naturalWidth || img.width;
      let h = img.naturalHeight || img.height;
      const ratio = w/h;
      if (Math.max(w,h) > MAX_DIMENSION){
        if (w > h){ w = MAX_DIMENSION; h = Math.round(w/ratio); }
        else { h = MAX_DIMENSION; w = Math.round(h*ratio); }
      }

      // set canvas pixel size (for real resolution)
      canvas.width = w; canvas.height = h;
      // style: make responsive by limiting width but keep pixel data
      canvas.style.width = Math.min(w, 860) + 'px';
      ctx.clearRect(0,0,w,h);
      ctx.drawImage(img, 0, 0, w, h);

      // backup original pixels so reset can restore exactly
      try{
        originalImageData = ctx.getImageData(0,0,w,h);
      }catch(err){
        // getImageData can fail for CORS images; in that case we still continue
        originalImageData = null;
      }

      currentImage = {w,h};
      info.textContent = 'Preview siap. Ubah slider untuk melihat efek.';
      applyDuotone();
    }

    function applyDuotone(){
      if (!currentImage) return;
      const w = currentImage.w, h = currentImage.h;
      // if we have originalImageData, work from it to avoid quality loss from repeated operations
      let imageData;
      try{
        if (originalImageData){
          // clone original data
          imageData = new ImageData(new Uint8ClampedArray(originalImageData.data), w, h);
        } else {
          imageData = ctx.getImageData(0,0,w,h);
        }
      }catch(err){
        alert('Gagal memproses gambar (CORS atau ukuran terlalu besar).');
        return;
      }

      const data = imageData.data;

      const highlight = hexToRgb(colorEl.value);
      const gamma = parseFloat(gammaEl.value);
      const intensity = parseFloat(intensityEl.value);
      const mix = parseFloat(mixEl.value);

      for (let i=0;i<data.length;i+=4){
        const r = data[i], g = data[i+1], b = data[i+2];
        // linear luminance (0..1)
        let lum = (0.2126*r + 0.7152*g + 0.0722*b) / 255;
        // gamma (contrast control)
        lum = Math.pow(lum, gamma);

        // map to highlight color (shadows map to near-black)
        const nr = Math.round(highlight[0] * lum * intensity);
        const ng = Math.round(highlight[1] * lum * intensity);
        const nb = Math.round(highlight[2] * lum * intensity);

        if (mix > 0){
          const gray = Math.round((r+g+b)/3);
          data[i]   = Math.round(nr * mix + gray * (1 - mix));
          data[i+1] = Math.round(ng * mix + gray * (1 - mix));
          data[i+2] = Math.round(nb * mix + gray * (1 - mix));
        } else {
          data[i] = nr; data[i+1] = ng; data[i+2] = nb;
        }
        // keep alpha as-is
      }

      ctx.putImageData(imageData, 0, 0);
    }

    // load file from File object
    function loadFile(file){
      if (!file || !file.type || !file.type.startsWith('image/')) return alert('Pilih file gambar yang valid.');
      originalBlob = file;
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = ()=>{ drawImageToCanvas(img); URL.revokeObjectURL(url); };
      img.onerror = ()=>{ alert('Gagal membuka gambar. Pastikan file tidak rusak.'); URL.revokeObjectURL(url); };
      img.src = url;
    }

    // file input change
    fileEl.addEventListener('change', e=>{
      if (!e.target.files || !e.target.files[0]) return;
      loadFile(e.target.files[0]);
    });

    // open button
    openBtn.addEventListener('click', ()=> fileEl.click());

    // drag & drop handlers
    ['dragenter','dragover'].forEach(ev=>{
      drop.addEventListener(ev, e=>{ e.preventDefault(); drop.style.borderColor = 'var(--accent)'; drop.style.boxShadow = '0 6px 24px rgba(239,68,68,0.08)'; });
    });
    ['dragleave','drop'].forEach(ev=>{
      drop.addEventListener(ev, e=>{ e.preventDefault(); drop.style.borderColor = 'rgba(255,255,255,0.06)'; drop.style.boxShadow='none'; });
    });
    drop.addEventListener('drop', e=>{
      if (e.dataTransfer.files && e.dataTransfer.files[0]) loadFile(e.dataTransfer.files[0]);
    });

    // paste image from clipboard
    window.addEventListener('paste', e=>{
      const items = e.clipboardData && e.clipboardData.items;
      if (!items) return;
      for (let i=0;i<items.length;i++){
        if (items[i].type.indexOf('image') !== -1){
          const file = items[i].getAsFile();
          loadFile(file);
          break;
        }
      }
    });

    // UI bindings
    [colorEl,gammaEl,intensityEl,mixEl].forEach(el=>el.addEventListener('input', ()=>{
      gammaVal.textContent = parseFloat(gammaEl.value).toFixed(2);
      intVal.textContent = parseFloat(intensityEl.value).toFixed(2);
      mixVal.textContent = parseFloat(mixEl.value).toFixed(2);
      applyDuotone();
    }));

    // download/save: use toBlob (better for large images)
    downloadBtn.addEventListener('click', ()=>{
      if (!currentImage || canvas.width === 0) return alert('Muat gambar terlebih dahulu.');
      // try toBlob first
      if (canvas.toBlob){
        canvas.toBlob(blob=>{
          if (!blob) return alert('Gagal membuat file PNG.');
          const a = document.createElement('a');
          const url = URL.createObjectURL(blob);
          a.href = url;
          a.download = 'duotone-red-black.png';
          document.body.appendChild(a);
          a.click();
          a.remove();
          setTimeout(()=> URL.revokeObjectURL(url), 1000);
        }, 'image/png');
      } else {
        // fallback
        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/png');
        a.download = 'duotone-red-black.png';
        a.click();
      }
    });

    // reset: restore original pixels and controls
    resetBtn.addEventListener('click', ()=>{
      colorEl.value = '#ff0000'; gammaEl.value='1'; intensityEl.value='1'; mixEl.value='0';
      gammaVal.textContent='1.00'; intVal.textContent='1.00'; mixVal.textContent='0.00';

      if (originalImageData){
        // restore backed up pixels
        canvas.width = originalImageData.width;
        canvas.height = originalImageData.height;
        ctx.putImageData(originalImageData, 0, 0);
        currentImage = {w:canvas.width,h:canvas.height};
        info.textContent = 'Gambar dikembalikan ke keadaan asli.';
      } else if (originalBlob){
        // reload the original file (if available)
        loadFile(originalBlob);
      } else {
        // nothing to reset
        info.textContent = 'Tidak ada gambar untuk direset.';
      }
    });

    // small helpers: initial UI values
    gammaVal.textContent = parseFloat(gammaEl.value).toFixed(2);
    intVal.textContent = parseFloat(intensityEl.value).toFixed(2);
    mixVal.textContent = parseFloat(mixEl.value).toFixed(2);

    // accessibility: keyboard open when drop focused
    drop.addEventListener('keydown', e=>{ if (e.key === 'Enter' || e.key === ' ') fileEl.click(); });

  </script>
</body>
</html>
